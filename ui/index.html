<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>awshound Viewer</title>
  <style>
    :root { --header-h: 56px; }
    html, body { height: 100%; }
    body { font-family: 'Inter', sans-serif; margin: 0; background: #0f121a; color: #e6e8ef; transition: background 0.2s, color 0.2s; overflow: hidden; }
    header { height: var(--header-h); padding: 12px 24px; box-sizing: border-box; display: flex; align-items: center; justify-content: space-between; background: #0f121a; color: #f2f2f2; }
    header .brand { font-weight: 700; letter-spacing: 0.5px; }
    header .status { font-size: 0.9rem; display: flex; gap: 12px; align-items: center; }
    header .status .pill { padding: 4px 8px; border-radius: 999px; background: #1e7cf2; color: #fff; font-size: 0.8rem; transition: background 0.2s, color 0.2s; }
    .layout { display: grid; grid-template-columns: 280px 1fr; height: calc(100vh - var(--header-h)); }
    nav { background: #111625; color: #e6e8ef; padding: 16px; display: flex; flex-direction: column; gap: 12px; height: calc(100vh - var(--header-h)); overflow-y: auto; box-sizing: border-box; transition: background 0.2s, color 0.2s; }
    nav h3 { margin: 8px 0; font-size: 0.95rem; text-transform: uppercase; letter-spacing: 0.5px; color: #9aa6c4; }
    nav .section { background: #151b2c; border: 1px solid #1f2a3d; border-radius: 8px; padding: 12px; transition: background 0.2s, border 0.2s; }
    nav label, nav input, nav select, nav button { font-size: 0.9rem; }
    .main { padding: 20px; background: #0f121a; color: #e6e8ef; height: calc(100vh - var(--header-h)); overflow-y: auto; box-sizing: border-box; }
    .drop { border: 2px dashed #444; padding: 1rem; margin-bottom: 1rem; background: #fff; }
    pre { background: #111; color: #eee; padding: 0.5rem; overflow: auto; }
    .card { background: #fff; border: 1px solid #ddd; border-radius: 6px; padding: 1rem; margin-bottom: 1rem; transition: background 0.2s, color 0.2s, border 0.2s; }
    .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 1rem; }
    table { width: 100%; border-collapse: collapse; }
    th, td { padding: 4px 6px; border-bottom: 1px solid #eee; font-size: 0.9rem; text-align: left; }
    .pill { display: inline-block; padding: 2px 6px; border-radius: 4px; font-size: 0.75rem; color: #fff; }
    .high { background: #c0392b; }
    .medium { background: #f39c12; color: #111; }
    .low { background: #27ae60; }
    #cy { width: 100%; height: 500px; border: 1px solid #ccc; border-radius: 6px; background: #fff; }
    .controls { display: flex; gap: 1rem; margin-bottom: 1rem; flex-wrap: wrap; }
    input[type="search"] { padding: 6px; }
    #legend { display: flex; gap: 1rem; flex-wrap: wrap; margin-bottom: 0.5rem; }
    .legend-item { display: flex; align-items: center; gap: 6px; font-size: 0.9rem; }
    .legend-swatch { width: 16px; height: 16px; border-radius: 3px; display: inline-block; }
    #detail { background: #fff; border: 1px solid #ddd; border-radius: 6px; padding: 0.75rem; margin-top: 1rem; font-size: 0.9rem; }
    #detail pre { background: #f4f4f4; color: #222; }
  </style>
  <script src="https://unpkg.com/cytoscape@3.28.1/dist/cytoscape.min.js"></script>
</head>
<body>
  <header>
    <div class="brand">AWSHound</div>
    <div class="status">
      <div class="pill" id="apiStatus">API: Unknown</div>
      <div class="pill" id="neo4jStatus">Neo4j: Unknown</div>
      <button id="themeToggle" style="padding:6px 10px; border-radius:6px; border:none; background:#2d8cff; color:#fff; cursor:pointer;">Toggle Theme</button>
    </div>
  </header>
  <div class="layout">
    <nav id="sidebar">
      <div class="toggle" id="sidebarToggle">☰</div>
      <div class="section">
        <h3>Filters</h3>
        <label>Severity<br>
          <select id="severityFilter" style="width:100%;">
            <option value="">All</option>
            <option value="high">High</option>
            <option value="medium">Medium</option>
            <option value="low">Low</option>
          </select>
        </label>
        <label>Search ID<br><input type="search" id="searchInput" placeholder="principal or resource id" style="width:100%;"></label>
        <label>Node type filter<br><input type="search" id="typeFilter" placeholder="Role, User, S3Bucket" style="width:100%;"></label>
        <button id="filterBtn" style="margin-top:8px; width:100%;">Apply Filters</button>
      </div>
      <div class="section">
        <h3>Cypher</h3>
        <textarea id="cypherInput" style="width:100%; min-height:100px; background:#0f121a; color:#e6e8ef; border:1px solid #2d3748;" placeholder="MATCH (n) RETURN n LIMIT 25"></textarea>
        <button id="runCypherBtn" style="margin-top:8px; width:100%;">Run Query</button>
        <div id="cypherStatus" style="font-size:0.85rem; margin-top:4px; color:#9aa6c4;"></div>
      </div>
    </nav>
    <main class="main">
      <div class="tabs" style="display:flex; gap:8px; margin-bottom:12px;">
        <button class="tab-btn" data-tab="graph" style="padding:8px 12px; border:none; border-radius:6px; background:#2d8cff; color:#fff; cursor:pointer;">Graph</button>
        <button class="tab-btn" data-tab="env" style="padding:8px 12px; border:none; border-radius:6px; background:#1f2733; color:#e6e8ef; cursor:pointer;">Environment</button>
        <button class="tab-btn" data-tab="data" style="padding:8px 12px; border:none; border-radius:6px; background:#1f2733; color:#e6e8ef; cursor:pointer;">Data Management</button>
        <button class="tab-btn" data-tab="settings" style="padding:8px 12px; border:none; border-radius:6px; background:#1f2733; color:#e6e8ef; cursor:pointer;">Settings</button>
      </div>
      <div id="msg" style="color:#c0392b; margin-bottom:1rem;"></div>
      <div id="tab-graph">
        <div id="legend">
          <div class="legend-item"><span class="legend-swatch" style="background:#4A90E2"></span>Node</div>
          <div class="legend-item"><span class="legend-swatch" style="background:#ccc"></span>Edge</div>
          <div class="legend-item"><span class="legend-swatch" style="background:#c0392b"></span>AttackPath</div>
        </div>
        <div class="card">
          <div style="display:flex; justify-content: space-between; align-items:center;">
            <h3>Graph View (Org/Trust/Attack Paths)</h3>
            <div>
              <button id="fullscreenBtn" style="padding:6px 10px; border:none; border-radius:6px; background:#2d8cff; color:#fff; cursor:pointer;">Fullscreen</button>
            </div>
          </div>
          <div id="cy" style="position:relative;"></div>
          <div id="graphResizer" style="height:8px; cursor:ns-resize; background:#1f2a3d; border-radius:4px; margin-top:6px;"></div>
        </div>
        <div class="card">
          <h3>Attack Paths</h3>
          <table id="attacksTable">
            <thead><tr><th>Rule</th><th>Description</th><th>Severity</th><th>Src → Dst</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
        <div id="detail" class="card">
          <h3>Selection Details</h3>
          <div id="detailContent">Click a node or edge to view details.</div>
        </div>
        <div id="cypherResults" class="card">
          <h3>Cypher Results</h3>
          <pre id="cypherOutput" style="max-height:200px; overflow:auto; background:#0f121a; color:#e6e8ef;"></pre>
        </div>
      </div>
      <div id="tab-env" style="display:none;">
        <div class="card">
          <details open>
            <summary style="cursor:pointer; font-weight:600;">Environment Object Details</summary>
            <div id="envDetails" style="margin-top:8px;"></div>
          </details>
        </div>
        <div class="card">
          <h3>Environment Summary</h3>
          <div id="envSummary">No data</div>
        </div>
      </div>
      <div id="tab-data" style="display:none;">
        <div class="card">
          <h3>Data Management</h3>
          <div class="drop">
            <label>Nodes file:<br><input type="file" id="nodesFile" accept=".jsonl"></label><br>
            <label>Edges file:<br><input type="file" id="edgesFile" accept=".jsonl"></label><br>
            <button id="loadBtn" style="margin-top:8px;">Load Files</button>
          </div>
          <div style="margin-top:10px;">
            <button id="fetchApiBtn" style="margin-top:8px;">Fetch from API</button>
          </div>
          <div style="margin-top:10px;">
            <button id="downloadReportBtn" style="margin-top:8px;">Download Report</button>
          </div>
        </div>
      </div>
      <div id="tab-settings" style="display:none;">
        <div class="card">
          <h3>Settings</h3>
          <label>API base:<br><input type="text" id="apiBase" value="http://127.0.0.1:5000" size="27"></label><br>
          <label>Layout<br>
            <select id="layoutSelect" style="width:100%;">
              <option value="cose">COSE</option>
              <option value="breadthfirst">Breadthfirst</option>
              <option value="concentric">Concentric</option>
            </select>
          </label>
          <label>Node label position<br>
            <select id="labelPos" style="width:100%;">
              <option value="center">Center</option>
              <option value="top">Above</option>
              <option value="bottom">Below</option>
              <option value="left">Left</option>
              <option value="right">Right</option>
            </select>
          </label>
          <label>Theme<br>
            <select id="theme" style="width:100%;">
              <option value="dark">Dark</option>
              <option value="light">Light</option>
            </select>
          </label>
        </div>
      </div>
    </main>
  </div>
  <script>
    function parseJsonl(text) {
      return text.trim().split(/\r?\n/).filter(Boolean).map(line => JSON.parse(line));
    }
    async function readFile(input) {
      if (!input.files || input.files.length === 0) return [];
      const file = input.files[0];
      const text = await file.text();
      return parseJsonl(text);
    }
    function renderStats(nodes, edges) {
      const counts = {};
      nodes.forEach(n => { counts[n.type] = (counts[n.type] || 0) + 1; });
      renderEnvDetails(counts);
      renderEnvSummary(nodes);
    }
    function renderAttacks(edges) {
      const tbody = document.querySelector('#attacksTable tbody');
      const attacks = edges.filter(e => e.type === 'AttackPath');
      tbody.innerHTML = attacks.map(e => {
        const sev = (e.properties && e.properties.severity) || 'info';
        return `<tr>
          <td>${e.properties?.rule || ''}</td>
          <td>${e.properties?.description || ''}</td>
          <td><span class="pill ${sev}">${sev}</span></td>
          <td><code>${e.src}</code> → <code>${e.dst}</code></td>
        </tr>`;
      }).join('') || '<tr><td colspan="4">No attack paths</td></tr>';
    }
    function renderEnvDetails(counts) {
      const env = document.getElementById('envDetails');
      if (!env) return;
      const keys = Object.keys(counts).sort();
      env.innerHTML = keys.map(k => `<div style="display:flex; justify-content:space-between; padding:4px 0; border-bottom:1px solid #2d3748;"><span>${k}</span><span>${counts[k]}</span></div>`).join('') || '<div>No data</div>';
    }
    function renderEnvSummary(nodes) {
      const summary = document.getElementById('envSummary');
      if (!summary) return;
      const samples = nodes.slice(0, 50).map(n => `<li><strong>${n.type}</strong>: ${n.id}</li>`).join('');
      summary.innerHTML = samples ? `<ul>${samples}</ul>` : 'No data';
    }
    function nodeLabel(n) {
      const props = n.properties || {};
      return props.name || props.role_name || props.user_name || props.id || n.id || n.type;
    }
    function nodeColor(type) {
      const t = (type || '').toLowerCase();
      if (t.includes('account')) return '#2c3e50';
      if (t.includes('role')) return '#6c5ce7';
      if (t.includes('user')) return '#00b894';
      if (t.includes('s3')) return '#f1c40f';
      if (t.includes('kms')) return '#d35400';
      if (t.includes('securitygroup')) return '#0984e3';
      if (t.includes('ami') || t.includes('snapshot')) return '#8e44ad';
      if (t.includes('ecr')) return '#16a085';
      if (t.includes('lambda')) return '#e67e22';
      return '#4A90E2';
    }
    function buildGraph(nodes, edges, severityFilter, searchTerm, typeFilter, layoutName) {
      if (typeof cytoscape === 'undefined') return;
      const search = searchTerm?.toLowerCase() || '';
      const typeFilterLower = typeFilter?.toLowerCase() || '';
      const filteredEdges = edges.filter(e => {
        if (e.type !== 'AttackPath') return true;
        if (severityFilter && (e.properties?.severity || '').toLowerCase() !== severityFilter.toLowerCase()) return false;
        return true;
      });
      const nodeMap = {};
      nodes.forEach(n => {
        if (search && !n.id.toLowerCase().includes(search)) return;
        if (typeFilterLower && n.type.toLowerCase().indexOf(typeFilterLower) === -1) return;
        nodeMap[n.id] = n;
      });
      filteredEdges.forEach(e => {
        if (!nodeMap[e.src]) {
          nodeMap[e.src] = { id: e.src, type: 'Unknown' };
        }
        if (!nodeMap[e.dst]) {
          nodeMap[e.dst] = { id: e.dst, type: 'Unknown' };
        }
      });
      const elements = [];
      Object.values(nodeMap).forEach(n => elements.push({ data: { id: n.id, label: nodeLabel(n), type: n.type } }));
      filteredEdges.forEach((e, idx) => {
        elements.push({
          data: {
            id: `${e.src}->${e.dst}:${e.type}:${idx}`,
            source: e.src,
            target: e.dst,
            label: e.type === 'AttackPath' ? (e.properties?.rule || e.type) : e.type,
            severity: e.properties?.severity || '',
          },
          classes: e.type === 'AttackPath' ? 'attack' : '',
        });
      });
      if (!window.cy || typeof window.cy.add !== 'function') {
        window.cy = cytoscape({ container: document.getElementById('cy') });
        bindDetail(window.cy);
      }
      window.cy.elements().remove();
      window.cy.add(elements);
      applyStyles(window.cy);
      window.cy.layout({ name: layoutName || 'cose', animate: false }).run();
    }
    function colorBySeverity(sev) {
      const s = (sev || '').toLowerCase();
      if (s === 'high') return '#c0392b';
      if (s === 'medium') return '#f39c12';
      if (s === 'low') return '#27ae60';
      return '#c0392b';
    }
    function bindDetail(cy) {
      const detail = document.getElementById('detailContent');
      cy.on('tap', 'node, edge', evt => {
        const data = evt.target.data();
        const props = evt.target.data();
        detail.innerHTML = `<strong>${evt.target.isNode() ? 'Node' : 'Edge'}:</strong> <code>${data.id || ''}</code><br><strong>Data:</strong><pre>${JSON.stringify(props, null, 2)}</pre>`;
      });
      cy.on('tap', evt => {
        if (evt.target === cy) {
          detail.innerHTML = 'Click a node or edge to view details.';
        }
      });
    }
    function applyStyles(cy) {
      const theme = document.getElementById('theme').value || 'light';
      const labelPos = document.getElementById('labelPos').value || 'center';
      const textColors = theme === 'dark' ? '#f2f2f2' : '#111';
      const bgColor = theme === 'dark' ? '#0f121a' : '#f8f9fb';
      const edgeColor = theme === 'dark' ? '#7f8c8d' : '#ccc';
      const textBg = theme === 'dark' ? '#111c' : '#ffffffcc';
      const nodeTextColor = theme === 'dark' ? '#111' : '#111'; // use dark text on pill backgrounds
      document.body.style.background = bgColor;
      document.body.style.color = textColors;
      const light = theme === 'light';
      document.querySelectorAll('.card').forEach(card => {
        card.style.background = light ? '#fff' : '#1a1f2b';
        card.style.borderColor = light ? '#ddd' : '#2d3748';
        card.style.color = light ? '#111' : '#e6e8ef';
      });
      const drop = document.querySelector('.drop');
      if (drop) {
        drop.style.background = light ? '#fff' : '#1a1f2b';
        drop.style.borderColor = light ? '#444' : '#2d3748';
        drop.style.color = light ? '#111' : '#e6e8ef';
      }
      document.querySelectorAll('input, select, button, textarea').forEach(el => {
        el.style.background = light ? '#fff' : '#0f121a';
        el.style.color = light ? '#111' : '#e6e8ef';
        el.style.border = light ? '1px solid #ccc' : '1px solid #2d3748';
      });
      const headerEl = document.querySelector('header');
      if (headerEl) {
        headerEl.style.background = light ? '#f8f9fb' : '#0f121a';
        headerEl.style.color = light ? '#111' : '#f2f2f2';
      }
      document.querySelectorAll('.status .pill').forEach(p => {
        p.style.background = light ? '#1e7cf2' : '#1e7cf2';
        p.style.color = '#fff';
      });
      const cyContainer = document.getElementById('cy');
      if (cyContainer) cyContainer.style.background = light ? '#fff' : '#0b0f17';
      document.querySelector('.main').style.background = light ? '#f8f9fb' : '#0f121a';
      const navEl = document.querySelector('nav');
      if (navEl) navEl.style.background = light ? '#f0f2f7' : '#111625';
      document.querySelectorAll('nav .section').forEach(sec => {
        sec.style.background = light ? '#f7f8fc' : '#151b2c';
        sec.style.borderColor = light ? '#d1d5db' : '#1f2a3d';
        sec.style.color = light ? '#111' : '#e6e8ef';
      });
      const tabs = document.querySelectorAll('.tab-btn');
      tabs.forEach(btn => {
        if (btn.dataset.tab === 'graph') {
          btn.style.background = '#2d8cff';
        } else {
          btn.style.background = '#1f2733';
        }
        btn.style.color = '#fff';
      });
      cy.style()
        .selector('node').style({
          'background-color': ele => nodeColor(ele.data('type')),
          'label': 'data(label)',
          'font-size': 9,
          'color': nodeTextColor,
          'width': 28,
          'height': 28,
          'text-wrap': 'wrap',
          'text-max-width': 80,
          'text-valign': labelPos === 'top' ? 'top' : labelPos === 'bottom' ? 'bottom' : 'center',
          'text-halign': labelPos === 'left' ? 'left' : labelPos === 'right' ? 'right' : 'center',
          'text-margin-y': labelPos === 'top' ? -12 : labelPos === 'bottom' ? 12 : 0,
          'text-margin-x': labelPos === 'left' ? -12 : labelPos === 'right' ? 12 : 0,
          'font-weight': 'bold',
          'border-width': 2,
          'border-color': theme === 'dark' ? '#ffffff66' : '#00000033',
          'shadow-blur': 8,
          'shadow-color': theme === 'dark' ? '#0007' : '#0003',
          'text-background-color': theme === 'dark' ? '#f4f4f4' : '#ffffff',
          'text-background-opacity': 0.9,
          'text-background-shape': 'roundrectangle',
          'text-background-padding': 2
        })
        .selector('edge').style({
          'width': 1.2,
          'line-color': edgeColor,
          'target-arrow-shape': 'triangle',
          'arrow-scale': 0.8,
          'curve-style': 'bezier',
          'label': 'data(label)',
          'font-size': 7,
          'color': textColors,
          'target-arrow-color': edgeColor
        })
        .selector('.attack').style({
          'line-color': ele => colorBySeverity(ele.data('severity')),
          'target-arrow-color': ele => colorBySeverity(ele.data('severity')),
          'width': 2,
          'label': 'data(label)',
          'color': textColors
        })
        .update();
    }
    document.getElementById('loadBtn').addEventListener('click', async () => {
      const msg = document.getElementById('msg');
      msg.textContent = '';
      if (typeof cytoscape === 'undefined') {
        msg.textContent = 'Cytoscape failed to load; check network or try again.';
        return;
      }
      const nodes = await readFile(document.getElementById('nodesFile'));
      const edges = await readFile(document.getElementById('edgesFile'));
      window._awsh_nodes = nodes;
      window._awsh_edges = edges;
      renderStats(nodes, edges);
      renderAttacks(edges);
      buildGraph(
        nodes,
        edges,
        document.getElementById('severityFilter').value,
        document.getElementById('searchInput').value,
        document.getElementById('typeFilter').value,
        document.getElementById('layoutSelect').value
      );
    });
    document.getElementById('filterBtn').addEventListener('click', () => {
      const nodes = window._awsh_nodes || [];
      const edges = window._awsh_edges || [];
      renderAttacks(edges.filter(e => {
        if (e.type !== 'AttackPath') return true;
        const sev = (e.properties?.severity || '').toLowerCase();
        const filter = document.getElementById('severityFilter').value.toLowerCase();
        if (filter && sev !== filter) return false;
        return true;
      }));
      buildGraph(
        nodes,
        edges,
        document.getElementById('severityFilter').value,
        document.getElementById('searchInput').value,
        document.getElementById('typeFilter').value,
        document.getElementById('layoutSelect').value
      );
    });
    async function fetchFromApi() {
        const base = document.getElementById('apiBase').value;
        const msg = document.getElementById('msg');
        msg.textContent = '';
        try {
          const resp = await fetch(`${base}/graph?limit=1000`);
          if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
          const data = await resp.json();
          const nodes = data.nodes || [];
          const edges = data.edges || [];
          window._awsh_nodes = nodes;
          window._awsh_edges = edges;
          renderStats(nodes, edges);
          renderAttacks(edges);
          buildGraph(
            nodes,
            edges,
            document.getElementById('severityFilter').value,
            document.getElementById('searchInput').value,
            document.getElementById('typeFilter').value,
            document.getElementById('layoutSelect').value
          );
          updateStatus(true, true);
        } catch (err) {
          msg.textContent = `API fetch failed: ${err}`;
          updateStatus(false, false);
        }
    }
    document.getElementById('fetchApiBtn').addEventListener('click', fetchFromApi);

    function updateStatus(apiOk, neoOk) {
      const apiPill = document.getElementById('apiStatus');
      const neoPill = document.getElementById('neo4jStatus');
      apiPill.textContent = `API: ${apiOk ? 'OK' : 'Error'}`;
      apiPill.style.background = apiOk ? '#16a085' : '#c0392b';
      neoPill.textContent = `Neo4j: ${neoOk ? 'OK' : 'Unknown'}`;
      neoPill.style.background = neoOk ? '#16a085' : '#c0392b';
    }

    async function runCypher() {
      const base = document.getElementById('apiBase').value;
      const cypher = document.getElementById('cypherInput').value;
      const status = document.getElementById('cypherStatus');
      const output = document.getElementById('cypherOutput');
      status.textContent = 'Running...';
      try {
        const resp = await fetch(`${base}/query`, {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({ cypher, limit: 200 }),
        });
        const data = await resp.json();
        if (!resp.ok) {
          status.textContent = `Error: ${data.error || resp.status}`;
          return;
        }
        status.textContent = 'Success';
        output.textContent = JSON.stringify(data.results || [], null, 2);
      } catch (err) {
        status.textContent = `Error: ${err}`;
      }
    }
    document.getElementById('runCypherBtn').addEventListener('click', runCypher);

    document.getElementById('themeToggle').addEventListener('click', () => {
      const themeSelect = document.getElementById('theme');
      themeSelect.value = themeSelect.value === 'dark' ? 'light' : 'dark';
      applyStyles(window.cy || {});
      if (window._awsh_nodes && window._awsh_edges) {
        buildGraph(
          window._awsh_nodes,
          window._awsh_edges,
          document.getElementById('severityFilter').value,
          document.getElementById('searchInput').value,
          document.getElementById('typeFilter').value,
          document.getElementById('layoutSelect').value
        );
      }
    });

    document.querySelectorAll('.tab-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('.tab-btn').forEach(b => b.style.background = '#1f2733');
        btn.style.background = '#2d8cff';
        const tab = btn.dataset.tab;
        ['graph','env','data','settings'].forEach(t => {
          const el = document.getElementById(`tab-${t}`);
          if (el) el.style.display = (tab === t) ? 'block' : 'none';
        });
      });
    });

    const sidebarToggle = document.getElementById('sidebarToggle');
    sidebarToggle.addEventListener('click', () => {
      const layout = document.querySelector('.layout');
      const nav = document.getElementById('sidebar');
      const collapsed = layout.classList.toggle('collapsed');
      nav.classList.toggle('collapsed', collapsed);
    });

    const fsBtn = document.getElementById('fullscreenBtn');
    let fullScreenOn = false;
    fsBtn.addEventListener('click', () => {
      const cyCard = document.getElementById('cy').parentElement;
      fullScreenOn = !fullScreenOn;
      cyCard.style.position = fullScreenOn ? 'fixed' : 'relative';
      cyCard.style.top = fullScreenOn ? '10px' : 'auto';
      cyCard.style.left = fullScreenOn ? '10px' : 'auto';
      cyCard.style.right = fullScreenOn ? '10px' : 'auto';
      cyCard.style.bottom = fullScreenOn ? '10px' : 'auto';
      cyCard.style.zIndex = fullScreenOn ? '999' : '1';
      if (fullScreenOn) {
        document.body.style.overflow = 'hidden';
        document.getElementById('cy').style.height = 'calc(100vh - 80px)';
        if (window.cy) window.cy.resize();
      } else {
        document.body.style.overflow = 'hidden';
        document.getElementById('cy').style.height = '';
        if (window.cy) window.cy.resize();
      }
    });

    const resizer = document.getElementById('graphResizer');
    let isResizing = false;
    resizer.addEventListener('mousedown', (e) => {
      isResizing = true;
      e.preventDefault();
    });
    window.addEventListener('mousemove', (e) => {
      if (!isResizing) return;
      const cyEl = document.getElementById('cy');
      const newH = Math.min(900, Math.max(300, e.clientY - cyEl.getBoundingClientRect().top));
      cyEl.style.height = `${newH}px`;
      if (window.cy) window.cy.resize();
    });
    window.addEventListener('mouseup', () => { isResizing = false; });

    const downloadBtn = document.getElementById('downloadReportBtn');
    if (downloadBtn) {
      downloadBtn.addEventListener('click', () => {
        const nodes = window._awsh_nodes || [];
        const edges = window._awsh_edges || [];
        const attackEdges = edges.filter(e => e.type === 'AttackPath');
        const counts = {};
        nodes.forEach(n => { counts[n.type] = (counts[n.type] || 0) + 1; });
        const report = {
          generated_at: new Date().toISOString(),
          node_count: nodes.length,
          edge_count: edges.length,
          counts,
          sample_nodes: nodes.slice(0, 100),
          attack_paths: attackEdges,
        };
        const blob = new Blob([JSON.stringify(report, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'awshound-report.json';
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(url);
      });
    }

    // Initial style apply
    applyStyles(window.cy || {});
  </script>
</body>
</html>
